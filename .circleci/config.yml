version: 2.1

executors:
  node:
    docker:
      - image: node:14-buster
  node_10:
    docker:
      - image: node:10-buster

orbs:
  codecov: codecov/codecov@1.1.1

commands:
  lint:
    description: Run ESLint.
    parameters:
      path:
        type: string
        default: .
    steps:
      - run:
          name: ESLint
          command: |
            cd << parameters.path >>
            mkdir -p $ARTIFACTS/test_results/eslint
            yarn lint --format="junit" --output-file="$ARTIFACTS/test_results/eslint/eslint.xml"
  test:
    description: Run Jest.
    parameters:
      path:
        type: string
        default: .
      coverage:
        type: boolean
        default: false
      script:
        type: string
        default: test
    steps:
      - run:
          name: Jest
          command: |
            cd << parameters.path >>
            export JEST_JUNIT_OUTPUT_DIR="$ARTIFACTS/test_results/jest"
            mkdir -p $JEST_JUNIT_OUTPUT_DIR
            yarn << parameters.script >> --ci <<# parameters.coverage >>--coverage<</ parameters.coverage >> --reporters="default" --reporters="jest-junit" --runInBand
          environment:
            JEST_JUNIT_OUTPUT_NAME: jest.xml
      - when:
          condition: << parameters.coverage >>
          steps:
            - run:
                name: Process coverage reports
                command: |
                  cp -v coverage/coverage-final.json $ARTIFACTS/coverage.json
                  tar -czvf $ARTIFACTS/coverage.tar.gz coverage/
            - codecov/upload:
                file: artifacts/coverage.json
  initialize:
    description: Initialize a JS project and create artifacts directory
    parameters:
      online:
        type: boolean
        default: false
    steps:
      - checkout
      - run:
          name: Node.js version
          command: |
            node --version
            npm --version
            yarn --version
      - run:
          name: Define Yarn cache directory
          command: |
            YARN_CACHE_FOLDER="$(pwd)/yarn_cache"
            echo "export YARN_CACHE_FOLDER=\"${YARN_CACHE_FOLDER}\"" >> $BASH_ENV
      - restore_cache:
          name: Restore Yarn cache
          keys:
            - yarn-v5-{{ .Branch }}-{{ checksum "yarn.lock" }}
      - run:
          name: Install Node modules
          # "--frozen-lockfile" doesn't work, see https://github.com/yarnpkg/yarn/issues/5840
          command: |
            CKSUM_BEFORE=$(cksum yarn.lock)
            ONLINE=<< parameters.online >>

            if [[ "$ONLINE" = true && ! -d "$YARN_CACHE_FOLDER" ]]; then
              mkdir -p $YARN_CACHE_FOLDER
              yarn install
            else
              yarn install --offline
            fi

            CKSUM_AFTER=$(cksum yarn.lock)

            if [[ $CKSUM_BEFORE != $CKSUM_AFTER ]]; then
              echo "yarn.lock is outdated"
              exit 1
            fi
      - when:
          condition: << parameters.online >>
          steps:
            - save_cache:
                name: Save Yarn cache
                key: yarn-v5-{{ .Branch }}-{{ checksum "yarn.lock" }}
                paths:
                  - yarn_cache
      - run:
          name: Setup artifacts directory
          command: |
            ARTIFACTS="$(pwd)/artifacts"
            echo "export ARTIFACTS=\"${ARTIFACTS}\"" >> $BASH_ENV
            mkdir -p $ARTIFACTS
      - run:
          name: Set release version
          command: |
            RELEASE_VERSION="$(yarn json version < lerna.json)"

            if [[ -z "<< pipeline.git.tag >>" ]]; then
              RELEASE_VERSION="${RELEASE_VERSION}+${CIRCLE_BUILD_NUM}.${CIRCLE_SHA1:0:7}"
              yarn lerna version --ignore-scripts --no-git-tag-version --no-private --no-push --yes "$RELEASE_VERSION"
            else
              RELEASE_VERSION="${RELEASE_VERSION}-next.${CIRCLE_BUILD_NUM}+${CIRCLE_SHA1:0:7}"
            fi

            echo "export RELEASE_VERSION=\"${RELEASE_VERSION}\"" >> $BASH_ENV

  finalize:
    description: Finalize a JS project build and upload its artifacts.
    parameters:
      persist:
        type: boolean
        default: true
    steps:
      - store_artifacts:
          path: artifacts
      - store_test_results:
          path: artifacts/test_results
      - when:
          condition: << parameters.persist >>
          steps:
            - persist_to_workspace:
                root: artifacts
                paths: "*.tgz"
  build:
    description: Run build and dist scripts.
    parameters:
      path:
        type: string
    steps:
      - run:
          name: Build
          command: |
            cd << parameters.path >>
            yarn build
      - run:
          name: Dist
          command: |
            cd << parameters.path >>
            yarn dist
            cp -v dist/* $ARTIFACTS

jobs:
  build_cli:
    executor: node_10
    working_directory: /mnt/ramdisk
    steps:
      - initialize
      - test:
          path: packages/undercut-cli
      - build:
          path: packages/undercut-cli
      - finalize

  build_node_10:
    executor: node_10
    working_directory: /mnt/ramdisk
    steps:
      - initialize
      - test:
          path: packages/undercut-node-10
      - build:
          path: packages/undercut-node-10
      - finalize

  build_pull:
    executor: node
    working_directory: /mnt/ramdisk
    steps:
      - initialize
      - build:
          path: packages/undercut-pull
      - finalize

  build_push:
    executor: node
    working_directory: /mnt/ramdisk
    steps:
      - initialize
      - build:
          path: packages/undercut-push
      - finalize

  build_utils:
    executor: node
    working_directory: /mnt/ramdisk
    steps:
      - initialize
      - build:
          path: packages/undercut-utils
      - finalize

  build_web_2019:
    executor: node
    working_directory: /mnt/ramdisk
    steps:
      - initialize
      - test:
          path: packages/undercut-web-2019
      - build:
          path: packages/undercut-web-2019
      - finalize

  build_website:
    executor: node
    working_directory: /mnt/ramdisk
    steps:
      - initialize
      - build:
          path: website
      - finalize

  test_all:
    executor: node
    working_directory: /mnt/ramdisk
    steps:
      - initialize:
          online: true
      - lint
      - test:
          coverage: true
      - finalize:
          persist: false

  release:
    executor: node
    working_directory: /mnt/ramdisk
    steps:
      - attach_workspace:
          at: undercut
      - run:
          name: Pack all
          command: |
            mkdir artifacts
            tar -cv -f artifacts/undercut-${RELEASE_VERSION}.tar undercut
      - store_artifacts:
          path: artifacts

workflows:
  version: 2
  workflow:
    jobs:
      - test_all
      - build_pull:
          requires:
            - test_all
      - build_push:
          requires:
            - test_all
      - build_utils:
          requires:
            - test_all
      - build_node_10:
          requires:
            - build_pull
            - build_push
            - build_utils
      - build_cli:
          requires:
            - build_node_10
      - build_web_2019:
          requires:
            - build_pull
            - build_push
            - build_utils
      - build_website:
          requires:
            - test_all
      - release:
          requires:
            - build_pull
            - build_push
            - build_utils
            - build_cli
            - build_web_2019
            - build_website
